Все длительности передачи CAN оцениваются через понятие кванта времени, для задания которого мы устанавливаем значение предделителя (в этом проекте он равен 24). Таким образом, мы получаем длительность 1 кванта:

# Tq=1/(APB1/24)

# Tq=1/(54Мгц/24)=444.4 нс

- Первый сегмент – SYNC_SEG (SJW) – используется для синхронизации всех узлов сети CAN. Ожидается, что фронт сигнала должен находиться внутри именно этого сегмента.
- Второй сегмент - BS1 (Bit segment 1). Стандарт CAN включает в себя два сегмента - PROP_SEG и PHASE_SEG1. Оба этих сегмента в STM32 относятся к сегменту BS1. PROP_SEG нужен для компенсации физических задержек в сети, а PHASE_SEG1 используется для компенсации ошибки смещения фазы сигнала.
Сегмент BS1 определяет положение sample point (точки захвата). В этой точке модуль CAN анализирует уровень сигнала на шине, то есть определяет, принят рецессивный или доминантный бит.
- Третий сегмент - BS2 (Bit segment 2). Он представляет из себя сегмент PHASE_SEG2 интерфейса CAN. Его назначение такое же как и у PHASE_SEG1.
Сегмент BS2 определяет положение transmit point (точки передачи), то есть того момента времени, когда модуль CAN выдает на линию определенный бит.

Длительности этих сегментов таковы:

- SYNC_SEG (SJW): 1 квант времени
- Bit segment 1 (BS1): 1 - 16 квантов
- Bit segment 2 (BS2): 1 – 8 квантов

Устанавливая длительности различных сегментов, мы получаем время передачи одного бита в квантах. Зная длительность самого кванта, мы легко получаем время передачи бита в секундах. А уже из этого мы рассчитываем скорость передачи данных по шине. Только при настройке CAN нужно пройти в обратном направлении.

Пусть мы хотим задать скорость обмена равной 250 Кбит/с. Тогда время передачи одного бита:
# Tbit=1с/250000=4000нс
Длительность одного кванта мы уже задали равной 444.4нс. Таким образом, время 1-го бита в квантах:
# Tqbit=Tbit/Tq
# Tqbit=4000нс/444.4нс=9
Эти 9 квантов нужно распределить между тремя сегментами. SYNC_SEG (SJW) фиксирован (1 квант), значит остается 8 квантов на сегменты BS1 и BS2. Ставим в этом примере BS1 - 5 квантов, BS2 - 3 кванта и получаем нужную нам скорость обмена данными.
